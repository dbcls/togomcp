schema_info:
  title: AMR Portal
  description: |
    Antimicrobial resistance surveillance data from NCBI Pathogen Detection, PATRIC, and CABBAGE. Contains 1.7M phenotypic test results (susceptibility testing) and 1.1M genotypic AMR features (resistance genes/mutations) from bacterial isolates worldwide.
    Entity types: PhenotypeMeasurement (resistance tests with MIC/disk diffusion data), GenotypeFeature (AMR genes and mutations with genomic coordinates).
    Applications: resistance pattern analysis, genotype-phenotype correlation, geographic surveillance, temporal trends, multi-drug resistance profiling.
  endpoint: https://rdfportal.org/ebi/sparql
  base_uri: http://example.org/ebiamr#
  graphs:
    - http://rdfportal.org/dataset/amrportal
  kw_search_tools: []
  version:
    mie_version: "2.0"
    mie_created: "2025-02-10"
    data_version: "Current as of 2025"
    update_frequency: "Irregular updates"
  license:
    data_license: "Public domain (NCBI/EBI)"
    license_url: "https://www.ebi.ac.uk/about/terms-of-use"
  access:
    rate_limiting: "Standard SPARQL limits"
    max_query_timeout: "60 seconds"
    backend: "Virtuoso"

shape_expressions: |
  PREFIX amr: <http://example.org/ebiamr#>
  PREFIX dct: <http://purl.org/dc/terms/>
  PREFIX obo: <http://purl.obolibrary.org/obo/>
  
  <PhenotypeShape> {
    a [ amr:PhenotypeMeasurement ] ;
    amr:organism xsd:string ;
    amr:species xsd:string ;
    amr:genus xsd:string ;
    amr:antibioticName xsd:string ;
    amr:antibioticOntologyId IRI ? ;  # ARO IRI, 92.7% coverage
    amr:resistancePhenotype xsd:string ;  # Controlled: "resistant", "susceptible", "intermediate"
    amr:bioSample IRI ;  # Primary linkage key
    amr:assemblyId IRI ? ;
    amr:sraAccession IRI ? ;
    amr:country xsd:string ? ;
    amr:geographicalRegion xsd:string ? ;  # Controlled regions
    amr:isoCountryCode xsd:string ? ;
    amr:collectionYear xsd:integer ? ;
    amr:isolateId xsd:string ? ;
    amr:isolationSource xsd:string ? ;
    amr:host xsd:string ? ;
    amr:laboratoryTypingMethod xsd:string ? ;
    amr:astStandard xsd:string ? ;
    amr:measurementValue xsd:string ? ;
    amr:measurementSign xsd:string ? ;
    amr:measurementUnits xsd:string ? ;
    dct:references IRI *
  }
  
  <GenotypeShape> {
    a [ amr:GenotypeFeature ] ;
    amr:organism xsd:string ;
    amr:species xsd:string ;
    amr:genus xsd:string ;
    amr:amrClass xsd:string ;  # Controlled vocabulary (56 classes)
    amr:amrSubclass xsd:string ? ;
    amr:amrElementSymbol xsd:string ;
    amr:geneSymbol xsd:string ;
    amr:bioSample IRI ;  # Primary linkage key
    amr:assemblyId IRI ;
    amr:elementType xsd:string ;
    amr:region xsd:string ;
    amr:regionStart xsd:integer ;
    amr:regionEnd xsd:integer ;
    amr:strand xsd:string ;
    amr:evidenceType xsd:string ? ;
    amr:evidenceAccession xsd:string ? ;
    amr:antibioticName xsd:string ? ;  # 78.5% coverage
    obo:RO_0002162 IRI  # NCBI Taxonomy IRI, 100% coverage
  }

sample_rdf_entries:
  - title: Phenotypic Measurement with ARO Ontology
    description: Susceptibility test with ARO ontology IRI for standardized antibiotic classification.
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      
      [] a amr:PhenotypeMeasurement ;
        amr:organism "Streptococcus pneumoniae" ;
        amr:species "Streptococcus pneumoniae" ;
        amr:genus "Streptococcus" ;
        amr:antibioticName "trimethoprim-sulfamethoxazole" ;
        amr:antibioticOntologyId <http://purl.obolibrary.org/obo/ARO_3004024> ;
        amr:resistancePhenotype "susceptible" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA1028830> ;
        amr:country "Thailand" ;
        amr:geographicalRegion "South-Eastern Asia" ;
        amr:collectionYear 2010 ;
        amr:laboratoryTypingMethod "disk diffusion" ;
        amr:astStandard "CLSI" .

  - title: Genotypic AMR Feature with Taxonomy
    description: Efflux pump gene with NCBI Taxonomy IRI and genomic coordinates.
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      @prefix obo: <http://purl.obolibrary.org/obo/> .
      
      [] a amr:GenotypeFeature ;
        amr:organism "Neisseria gonorrhoeae" ;
        amr:species "Neisseria gonorrhoeae" ;
        amr:genus "Neisseria" ;
        amr:amrClass "EFFLUX" ;
        amr:amrElementSymbol "norM" ;
        amr:geneSymbol "mdtK" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA104147270> ;
        amr:assemblyId <https://identifiers.org/insdc.gca/ERZ25089697> ;
        amr:region "ERZ25089697.1" ;
        amr:regionStart 136650 ;
        amr:regionEnd 138029 ;
        amr:strand "-" ;
        amr:elementType "AMR" ;
        amr:evidenceType "HMM" ;
        obo:RO_0002162 <http://identifiers.org/taxonomy/485> .

  - title: Quantitative MIC Measurement
    description: Meropenem MIC test showing resistance with quantitative measurement details.
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      
      [] a amr:PhenotypeMeasurement ;
        amr:organism "Klebsiella pneumoniae" ;
        amr:species "Klebsiella pneumoniae" ;
        amr:genus "Klebsiella" ;
        amr:antibioticName "meropenem" ;
        amr:antibioticOntologyId <http://purl.obolibrary.org/obo/ARO_0000073> ;
        amr:resistancePhenotype "resistant" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA3136729> ;
        amr:laboratoryTypingMethod "broth dilution" ;
        amr:measurementValue "16" ;
        amr:measurementSign ">=" ;
        amr:measurementUnits "mg/L" .

  - title: Geographic Metadata Hierarchy
    description: Complete geographic hierarchy for regional surveillance analysis.
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      
      [] a amr:PhenotypeMeasurement ;
        amr:organism "Escherichia coli" ;
        amr:species "Escherichia coli" ;
        amr:genus "Escherichia" ;
        amr:antibioticName "ciprofloxacin" ;
        amr:antibioticOntologyId <http://purl.obolibrary.org/obo/ARO_0000036> ;
        amr:resistancePhenotype "resistant" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA9876543> ;
        amr:country "United States of America" ;
        amr:geographicalRegion "Americas" ;
        amr:isoCountryCode "USA" ;
        amr:collectionYear 2020 ;
        amr:isolationSource "urine" ;
        amr:host "Homo sapiens" .

  - title: Linked Phenotype-Genotype
    description: Isolate with both resistance phenotype and AMR gene via shared bioSample IRI.
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      @prefix obo: <http://purl.obolibrary.org/obo/> .
      
      [] a amr:PhenotypeMeasurement ;
        amr:organism "Acinetobacter baumannii" ;
        amr:antibioticName "amikacin" ;
        amr:antibioticOntologyId <http://purl.obolibrary.org/obo/ARO_3000019> ;
        amr:resistancePhenotype "resistant" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA1569508> ;
        amr:country "Viet Nam" ;
        amr:geographicalRegion "South-Eastern Asia" .
      
      [] a amr:GenotypeFeature ;
        amr:organism "Acinetobacter baumannii" ;
        amr:amrClass "AMINOGLYCOSIDE" ;
        amr:amrElementSymbol "aac(6')-Ib" ;
        amr:geneSymbol "aac(6')-Ib" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA1569508> ;
        amr:assemblyId <https://identifiers.org/insdc.gca/GCA_001234567> ;
        obo:RO_0002162 <http://identifiers.org/taxonomy/470> .

sparql_query_examples:
  - title: Query by ARO Antibiotic IRI
    description: Use specific ARO ontology IRI for ciprofloxacin (ARO_0000036).
    question: What resistance data exists for ciprofloxacin?
    complexity: basic
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      # GOOD: Use specific ARO IRI for comprehensive results
      SELECT ?organism ?phenotype ?country
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement ;
           amr:antibioticOntologyId <http://purl.obolibrary.org/obo/ARO_0000036> ;
           amr:organism ?organism ;
           amr:resistancePhenotype ?phenotype .
        OPTIONAL { ?s amr:country ?country }
      }
      LIMIT 100

  - title: Query Genotypes by Taxonomy IRI
    description: Use NCBI Taxonomy IRI for E. coli (taxid 562) to find all AMR genes.
    question: What AMR genes are found in Escherichia coli?
    complexity: basic
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX obo: <http://purl.obolibrary.org/obo/>
      
      # GOOD: Use specific NCBI Taxonomy IRI (100% coverage in genotypes)
      SELECT ?amrClass ?geneSymbol (COUNT(*) as ?count)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:GenotypeFeature ;
           obo:RO_0002162 <http://identifiers.org/taxonomy/562> ;
           amr:amrClass ?amrClass ;
           amr:geneSymbol ?geneSymbol .
      }
      GROUP BY ?amrClass ?geneSymbol
      ORDER BY DESC(?count)
      LIMIT 20

  - title: Filter by Typed Predicate
    description: Use exact string matching with typed predicate for resistance phenotype.
    question: Which antibiotics show resistance in Salmonella enterica?
    complexity: basic
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      # GOOD: Use exact matching with typed predicates
      SELECT ?antibiotic (COUNT(*) as ?count)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement ;
           amr:organism "Salmonella enterica" ;
           amr:antibioticName ?antibiotic ;
           amr:resistancePhenotype "resistant" .
      }
      GROUP BY ?antibiotic
      ORDER BY DESC(?count)
      LIMIT 20

  - title: Multiple ARO IRIs with VALUES
    description: Query multiple carbapenem antibiotics using ARO IRIs for comprehensive results.
    question: What is the resistance rate for carbapenem antibiotics?
    complexity: intermediate
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      # GOOD: Use VALUES with multiple specific ARO IRIs
      SELECT ?aro ?organism ?phenotype (COUNT(*) as ?total)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        VALUES ?aro {
          <http://purl.obolibrary.org/obo/ARO_0000073>  # meropenem
          <http://purl.obolibrary.org/obo/ARO_3000170>  # imipenem
          <http://purl.obolibrary.org/obo/ARO_0000069>  # ertapenem
        }
        ?s a amr:PhenotypeMeasurement ;
           amr:antibioticOntologyId ?aro ;
           amr:organism ?organism ;
           amr:resistancePhenotype ?phenotype .
      }
      GROUP BY ?aro ?organism ?phenotype
      ORDER BY DESC(?total)
      LIMIT 30

  - title: Geographic Distribution Analysis
    description: Analyze ciprofloxacin resistance using geographic typed predicates.
    question: Which regions have the highest ciprofloxacin resistance?
    complexity: intermediate
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      # GOOD: Use typed predicates for geographic filtering
      SELECT ?region ?country (COUNT(*) as ?resistant_count)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement ;
           amr:antibioticName "ciprofloxacin" ;
           amr:resistancePhenotype "resistant" ;
           amr:geographicalRegion ?region ;
           amr:country ?country .
      }
      GROUP BY ?region ?country
      ORDER BY DESC(?resistant_count)
      LIMIT 20

  - title: AMR Gene Class Distribution
    description: Query specific AMR classes using controlled vocabulary with VALUES.
    question: What are the most common AMR gene classes across different bacteria?
    complexity: intermediate
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX obo: <http://purl.obolibrary.org/obo/>
      
      # GOOD: Use VALUES for controlled vocabulary AMR classes
      SELECT ?amrClass ?species (COUNT(*) as ?count)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        VALUES ?amrClass {
          "BETA-LACTAM"
          "AMINOGLYCOSIDE"
          "QUINOLONE"
          "TETRACYCLINE"
        }
        ?s a amr:GenotypeFeature ;
           amr:amrClass ?amrClass ;
           amr:species ?species ;
           obo:RO_0002162 ?taxon .
      }
      GROUP BY ?amrClass ?species
      ORDER BY DESC(?count)
      LIMIT 20

  - title: Genotype-Phenotype Linkage
    description: Find beta-lactam genes in carbapenem-resistant isolates using exact class matching.
    question: Which beta-lactam genes are associated with carbapenem resistance?
    complexity: advanced
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      # GOOD: Use exact AMR class matching (not FILTER(CONTAINS))
      SELECT DISTINCT ?geneSymbol ?amrClass ?bioSample ?country
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        # Phenotype: carbapenem-resistant isolates
        ?pheno a amr:PhenotypeMeasurement ;
               amr:bioSample ?bioSample ;
               amr:antibioticName "meropenem" ;
               amr:resistancePhenotype "resistant" .
        OPTIONAL { ?pheno amr:country ?country }
        
        # Genotype: beta-lactam genes from same isolate
        ?geno a amr:GenotypeFeature ;
              amr:bioSample ?bioSample ;
              amr:geneSymbol ?geneSymbol ;
              amr:amrClass ?amrClass .
        FILTER(?amrClass = "BETA-LACTAM")
      }
      LIMIT 50

  - title: Multi-Drug Resistance Profiling
    description: Find isolates resistant to 3+ antibiotics with taxonomy linkage via genotypes.
    question: Which isolates show multi-drug resistance patterns?
    complexity: advanced
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX obo: <http://purl.obolibrary.org/obo/>
      
      # Complex aggregation with optional taxonomy linkage
      SELECT ?bioSample ?organism ?taxon
             (COUNT(DISTINCT ?ab) as ?resistantDrugs)
             (SAMPLE(?country) as ?location)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?pheno a amr:PhenotypeMeasurement ;
               amr:bioSample ?bioSample ;
               amr:organism ?organism ;
               amr:antibioticName ?ab ;
               amr:resistancePhenotype "resistant" .
        OPTIONAL { ?pheno amr:country ?country }
        
        # Link to genotype for taxonomy if available
        OPTIONAL {
          ?geno a amr:GenotypeFeature ;
                amr:bioSample ?bioSample ;
                obo:RO_0002162 ?taxon .
        }
      }
      GROUP BY ?bioSample ?organism ?taxon
      HAVING (COUNT(DISTINCT ?ab) >= 3)
      ORDER BY DESC(?resistantDrugs)
      LIMIT 20

cross_database_queries:
  shared_endpoint: ebi
  co_located_databases: [chembl, chebi, reactome, ensembl]
  examples:
    - title: Link AMR Data to ChEMBL Compounds
      description: |
        Integrate resistance data with ChEMBL compound properties using reverse join strategy.
        
        Linking strategy:
        - ChEMBL: use rdfs:label for compound names (small dataset - 3 compounds)
        - AMR Portal: aggregate resistance by antibiotic name (1.7M → ~200 rows)
        - Join on lowercase name matching
        - Reverse join (small→large) ensures fast execution
        
        MIE files referenced: chembl (for compound properties), amrportal (for resistance data)
      databases_used: [amrportal, chembl]
      complexity: intermediate
      sparql: |
        PREFIX amr: <http://example.org/ebiamr#>
        PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        
        # Start with small ChEMBL set, then join aggregated AMR results
        SELECT ?chemblLabel ?antibioticName ?resistanceCount
        WHERE {
          # Stage 1: Select specific ChEMBL compounds (3 rows)
          GRAPH <http://rdf.ebi.ac.uk/dataset/chembl> {
            VALUES ?chemblLabel { "CIPROFLOXACIN" "AMPICILLIN" "GENTAMICIN" }
            ?mol a cco:SmallMolecule ;
                 rdfs:label ?chemblLabel .
          }
          BIND(LCASE(?chemblLabel) AS ?antibioticName)
          
          # Stage 2: Aggregate AMR data within its own GRAPH
          GRAPH <http://rdfportal.org/dataset/amrportal> {
            SELECT ?antibioticName (COUNT(*) as ?resistanceCount)
            WHERE {
              ?m a amr:PhenotypeMeasurement ;
                 amr:antibioticName ?antibioticName ;
                 amr:resistancePhenotype "resistant" .
            }
            GROUP BY ?antibioticName
          }
        }
        LIMIT 10
      notes: |
        - Strategies: 1 (GRAPH), 2 (reverse join), 10 (LIMIT), two-stage aggregation
        - Performance: ~2-3s (Tier 1)
        - Start ChEMBL (3 molecules) → aggregate AMR → join results
        - Use LCASE for case-insensitive name matching
        - CRITICAL: Aggregate within GRAPH before join

    - title: Two-Stage Aggregation Pattern
      description: |
        Optimal pattern for cross-database analytics: aggregate first, then join.
        
        Linking strategy:
        - Stage 1: Aggregate AMR data independently (1.7M → 2 rows)
        - Stage 2: Join aggregated results to ChEMBL using antibiotic name
        - This avoids cross-GRAPH aggregation which causes timeouts
        
        MIE files referenced: amrportal, chembl
      databases_used: [amrportal, chembl]
      complexity: advanced
      sparql: |
        # STAGE 1: Aggregate in AMR (5-7s)
        PREFIX amr: <http://example.org/ebiamr#>
        SELECT ?antibiotic (COUNT(*) as ?resistant)
        FROM <http://rdfportal.org/dataset/amrportal>
        WHERE {
          ?s a amr:PhenotypeMeasurement ;
             amr:antibioticName ?antibiotic ;
             amr:resistancePhenotype "resistant" .
          FILTER(?antibiotic IN ("ciprofloxacin", "ampicillin"))
        }
        GROUP BY ?antibiotic
        
        # STAGE 2: Join to ChEMBL (<1s)
        PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        SELECT ?antibiotic ?resistant ?chemblLabel ?developmentPhase
        WHERE {
          # Use results from Stage 1
          VALUES (?antibiotic ?resistant) {
            ("ampicillin" 21660)
            ("ciprofloxacin" 21368)
          }
          GRAPH <http://rdf.ebi.ac.uk/dataset/chembl> {
            ?mol a cco:SmallMolecule ;
                 rdfs:label ?chemblLabel ;
                 cco:highestDevelopmentPhase ?developmentPhase .
            FILTER(LCASE(?chemblLabel) = ?antibiotic)
          }
        }
      notes: |
        - NEVER aggregate across GRAPHs
        - Total time: ~6-8s (5-7s + <1s) vs timeout
        - Reduces 1.7M → 2 rows before join
        - Run as two separate queries, use first results in second

    - title: Geographic Patterns with ChEBI Chemical Data
      description: |
        Analyze regional ciprofloxacin resistance enriched with ChEBI chemical ontology data.
        
        Linking strategy:
        - ChEBI MIE file examined: Found OLS4:searchClasses available
        - Used OLS4:searchClasses("ciprofloxacin") to discover specific IRI: CHEBI:100241
        - AMR Portal: pre-filter by region and antibiotic (reduces from 1.7M to ~100 rows)
        - ChEBI: use specific ciprofloxacin IRI for precise structured linkage
        - Structured approach ensures comprehensive and accurate chemical data enrichment
        
        MIE files referenced: amrportal (resistance data), chebi (chemical properties)
      databases_used: [amrportal, chebi]
      complexity: intermediate
      sparql: |
        PREFIX amr: <http://example.org/ebiamr#>
        PREFIX obo: <http://purl.obolibrary.org/obo/>
        PREFIX owl: <http://www.w3.org/2002/07/owl#>
        PREFIX chebi: <http://purl.obolibrary.org/obo/chebi/>
        
        SELECT ?region ?antibiotic ?chebiLabel ?formula ?mass
               (COUNT(*) as ?resistant_count)
        WHERE {
          # Pre-filter AMR data aggressively (1.7M → ~100 rows)
          GRAPH <http://rdfportal.org/dataset/amrportal> {
            ?m a amr:PhenotypeMeasurement ;
               amr:antibioticName ?antibiotic ;
               amr:geographicalRegion ?region ;
               amr:resistancePhenotype "resistant" .
            FILTER(?region = "Americas" && ?antibiotic = "ciprofloxacin")
          }
          
          # Use specific ChEBI IRI discovered via OLS4:searchClasses
          GRAPH <http://rdf.ebi.ac.uk/dataset/chebi> {
            obo:CHEBI_100241 a owl:Class ;
                             rdfs:label ?chebiLabel .
            OPTIONAL { obo:CHEBI_100241 chebi:formula ?formula }
            OPTIONAL { obo:CHEBI_100241 chebi:mass ?mass }
          }
        }
        GROUP BY ?region ?antibiotic ?chebiLabel ?formula ?mass
        LIMIT 20
      notes: |
        - Strategies: 1 (GRAPH), 2 (pre-filter), 3 (specific IRI), 7 (OPTIONAL), 10 (LIMIT)
        - MIE workflow: Examined chebi MIE → found OLS4:searchClasses → used to find CHEBI:100241
        - Pre-filtering reduces from 1.7M to ~100 rows before join (>99.9% reduction)
        - Performance: ~1-2s (Tier 1) with structured IRI approach
        - Geographic + antibiotic filter is critical for performance
        - Using specific ChEBI IRI ensures accurate and complete chemical data

cross_references:
  - pattern: amr:bioSample
    description: |
      Links to NCBI BioSample for metadata. Primary key for phenotype-genotype linking.
      Every measurement and feature links to a bioSample IRI.
    databases:
      sequence_archives:
        - "BioSample: 170,958 unique samples"
    sparql: |
      SELECT DISTINCT ?bioSample
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE { ?s amr:bioSample ?bioSample }
      LIMIT 100

  - pattern: amr:sraAccession / amr:assemblyId
    description: |
      Links to SRA and INSDC genome assemblies for sequence data access.
    databases:
      sequence_archives:
        - "SRA: ~870K accessions"
        - "INSDC: ~890K assemblies"
    sparql: |
      SELECT DISTINCT ?sra ?assembly
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        OPTIONAL { ?s amr:sraAccession ?sra }
        OPTIONAL { ?s amr:assemblyId ?assembly }
        FILTER(BOUND(?sra) || BOUND(?assembly))
      }
      LIMIT 100

  - pattern: dct:references
    description: |
      Citations to PubMed literature for methods and data sources.
    databases:
      literature:
        - "PubMed: Multiple publications"
    sparql: |
      SELECT DISTINCT ?pubmed
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE { ?s dct:references ?pubmed }
      LIMIT 100

  - pattern: amr:antibioticOntologyId
    description: |
      Links to ARO (Antibiotic Resistance Ontology) for standardized antibiotic terms.
      92.7% of phenotypes have ARO IRIs enabling precise antibiotic queries.
    databases:
      ontologies:
        - "ARO: CARD antibiotic classifications (92.7% coverage)"
    sparql: |
      SELECT DISTINCT ?aro ?antibiotic
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s amr:antibioticName ?antibiotic ;
           amr:antibioticOntologyId ?aro .
      }
      LIMIT 100

  - pattern: obo:RO_0002162
    description: |
      Links genotypes to NCBI Taxonomy using 'in taxon' relationship.
      100% of genotype features have taxonomy IRIs.
    databases:
      taxonomy:
        - "NCBI Taxonomy: All genotype features (100% coverage)"
    sparql: |
      SELECT DISTINCT ?taxon ?organism
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:GenotypeFeature ;
           amr:organism ?organism ;
           obo:RO_0002162 ?taxon .
      }
      LIMIT 100

architectural_notes:
  query_strategy:
    - "Discovery: No keyword search API available - use exploratory SPARQL with LIMIT"
    - "Comprehensive - Antibiotic queries: Use specific ARO IRIs (92.7% coverage) or exact antibiotic names"
    - "Comprehensive - Genotype organism queries: Use NCBI Taxonomy IRIs via obo:RO_0002162 (100% coverage)"
    - "Comprehensive - AMR classes: Use exact matching or VALUES with controlled vocabulary strings (56 distinct classes)"
    - "Comprehensive - Resistance phenotypes: Use exact matching with controlled values: 'resistant', 'susceptible', 'intermediate'"
    - "Geographic queries: Use typed predicates (geographicalRegion, country, isoCountryCode)"
    - "Cross-database: Use search tools from co-located databases to find specific IRIs before joining"
    - "Priority: ARO IRIs > Taxonomy IRIs > Exact matching > (text search not needed for structured fields)"
    - "Text search: NOT needed - all key fields use controlled vocabularies or specific IRIs"
  
  schema_design:
    - "Two primary entity types: PhenotypeMeasurement (1.7M), GenotypeFeature (1.1M)"
    - "All entities are blank nodes (no named URIs)"
    - "BioSample IRI is the primary linkage key between phenotypes and genotypes"
    - "ARO IRIs provide standardized antibiotic classification (92.7% coverage)"
    - "NCBI Taxonomy IRIs provide species identification in genotypes (100% coverage)"
    - "Geographic hierarchy: geographicalRegion → country → isoCountryCode"
    - "Temporal coverage: 92 collection years (1911-2025)"
    - "56 distinct AMR classes in controlled vocabulary"
    - "Resistance phenotypes use controlled vocabulary (resistant/susceptible/intermediate)"
  
  performance:
    - "Large dataset (2.8M total entities) requires careful query design"
    - "CRITICAL: Always use FROM clause to specify graph"
    - "CRITICAL: Use LIMIT for exploratory queries"
    - "CRITICAL: Use exact matching for controlled vocabularies (never FILTER(CONTAINS) for AMR classes or phenotypes)"
    - "For ARO queries: Specific IRIs give comprehensive results without text search"
    - "For taxonomy queries: Use obo:RO_0002162 predicate with taxonomy IRIs"
    - "Geographic/temporal filters significantly reduce result sets"
    - "Single antibiotic filter recommended before aggregation"
    - "Use SAMPLE() for representative geographic/temporal data"
    - "Cross-DB queries: Use reverse join (small→large) or two-stage aggregation"
    - "NEVER aggregate across GRAPHs - aggregate within single GRAPH first"
  
  data_integration:
    - "External links: BioSample, SRA, INSDC, PubMed, ARO, NCBI Taxonomy"
    - "Phenotype-genotype linkage via bioSample IRI enables comprehensive correlation studies"
    - "Co-located databases on EBI endpoint: ChEMBL, ChEBI, Reactome, Ensembl"
    - "ChEMBL integration via antibiotic name matching (use LCASE for case-insensitive)"
    - "ChEBI integration via specific IRIs discovered through OLS4:searchClasses"
    - "Two-stage aggregation pattern required for cross-database analytics"
    - "ARO ontology enables linkage to CARD database and other AMR resources"
  
  data_quality:
    - "Controlled vocabularies ensure data quality for key fields"
    - "ARO coverage: 92.7% of phenotypes have standardized antibiotic IRIs"
    - "Taxonomy coverage: 100% of genotypes have NCBI taxonomy IRIs"
    - "Geographic coverage: 83.9% have country, 78.4% have collection year"
    - "Resistance phenotype: 80.5% have explicit phenotype value"
    - "Some inconsistency in isolation source capitalization"
    - "Laboratory methods: 56% broth dilution, 8% agar, 7% disk diffusion"

data_statistics:
  total_phenotypes: 1714486
  total_genotypes: 1164007
  unique_biosamples: 170958
  verified_date: "2025-02-10"
  verification_method: "COUNT DISTINCT query on bioSample IRIs"
  verification_query: |
    PREFIX amr: <http://example.org/ebiamr#>
    SELECT (COUNT(DISTINCT ?b) as ?count)
    FROM <http://rdfportal.org/dataset/amrportal>
    WHERE { ?s amr:bioSample ?b }
  
  coverage:
    phenotypes_with_aro: "92.7%"
    calculation: "1,588,533 / 1,714,486"
    verified_date: "2025-02-10"
    verification_query: |
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT (COUNT(*) as ?total) (COUNT(?aro) as ?withARO)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        OPTIONAL { ?s amr:antibioticOntologyId ?aro }
      }
    
    phenotype_with_country: "83.9%"
    phenotype_with_year: "78.4%"
    genotype_with_taxonomy: "100%"
    genotype_with_antibiotic: "78.5%"
  
  resistance_distribution:
    susceptible: "60.7%"
    resistant: "17.7%"
    intermediate: "2.1%"
    missing: "19.5%"
  
  cardinality:
    avg_phenotypes_per_biosample: 10.0
    avg_genotypes_per_biosample: 6.8
    countries: 153
    unique_amr_classes: 56
  
  performance_benchmarks:
    single_antibiotic_aro_query: "<5s"
    aggregation_with_filters: "5-10s"
    cross_db_reverse_join: "1-2s"
    two_stage_aggregation: "~6-8s"
    cross_db_with_specific_iri: "~1-2s"
  
  staleness_warning: "Irregular updates; statistics verified 2025-02-10"

anti_patterns:
  - title: Skipping Schema Check Before Query Design
    problem: "Designing queries without checking MIE schema for structured properties."
    wrong_sparql: |
      # BAD: Jumping to text search without checking schema
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?gene WHERE {
        ?s amr:geneSymbol ?gene .
        ?gene bif:contains "'lactam'"
      }
    correct_sparql: |
      # CORRECT: Checked MIE schema first
      # 1. Read shape_expressions → found amr:amrClass with controlled vocabulary
      # 2. Found 56 AMR classes including "BETA-LACTAM"
      # 3. Use exact matching with controlled vocabulary:
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?gene ?amrClass WHERE {
        ?s a amr:GenotypeFeature ;
           amr:geneSymbol ?gene ;
           amr:amrClass ?amrClass .
        FILTER(?amrClass = "BETA-LACTAM")
      }
    explanation: |
      ALWAYS check MIE schema_expressions before writing queries. In this case, the schema shows amr:amrClass uses controlled vocabulary, eliminating the need for text search.

  - title: Using Text Search for Controlled Vocabulary
    problem: "Using FILTER(CONTAINS()) or bif:contains when exact matching with controlled vocabulary is available."
    wrong_sparql: |
      # BAD: Unindexed string matching for controlled vocabulary
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?geneSymbol ?amrClass
      WHERE {
        ?s a amr:GenotypeFeature ;
           amr:geneSymbol ?geneSymbol ;
           amr:amrClass ?amrClass .
        FILTER(CONTAINS(?amrClass, "BETA-LACTAM"))
      }
    correct_sparql: |
      # CORRECT: Use exact matching or VALUES for controlled vocabulary
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?geneSymbol ?amrClass
      WHERE {
        VALUES ?amrClass {
          "BETA-LACTAM"
          "BETA-LACTAM/MACROLIDE/TETRACYCLINE"
          "BETA-LACTAM/QUINOLONE/TETRACYCLINE"
        }
        ?s a amr:GenotypeFeature ;
           amr:geneSymbol ?geneSymbol ;
           amr:amrClass ?amrClass .
      }
    explanation: |
      AMR classes are controlled vocabulary (56 distinct values). Use exact matching with VALUES or FILTER(= "value"), never FILTER(CONTAINS()). This is faster and more precise.

  - title: Cross-GRAPH Aggregation
    problem: "Aggregating across multiple GRAPHs creates massive intermediate results causing timeouts."
    wrong_sparql: |
      # BAD: Aggregates across GRAPHs
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
      SELECT ?ab (COUNT(?m) as ?count)
      WHERE {
        GRAPH <http://rdfportal.org/dataset/amrportal> {
          ?m a amr:PhenotypeMeasurement ;
             amr:antibioticName ?ab ;
             amr:resistancePhenotype "resistant" .
        }
        GRAPH <http://rdf.ebi.ac.uk/dataset/chembl> {
          ?mol rdfs:label ?label .
          FILTER(LCASE(?label) = ?ab)
        }
      }
      GROUP BY ?ab
    correct_sparql: |
      # CORRECT: Two-stage aggregation
      # Stage 1: Aggregate within AMR GRAPH (5-7s)
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?ab (COUNT(*) as ?count)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?m a amr:PhenotypeMeasurement ;
           amr:antibioticName ?ab ;
           amr:resistancePhenotype "resistant" .
      }
      GROUP BY ?ab
      LIMIT 10
      
      # Stage 2: Join aggregated results to ChEMBL (<1s)
      # Use results from Stage 1 as VALUES
      PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
      SELECT ?ab ?count ?mol
      WHERE {
        VALUES (?ab ?count) {
          ("ciprofloxacin" 21368)
          ("ampicillin" 21660)
        }
        GRAPH <http://rdf.ebi.ac.uk/dataset/chembl> {
          ?mol rdfs:label ?label .
          FILTER(LCASE(?label) = ?ab)
        }
      }
    explanation: |
      NEVER aggregate across GRAPHs. Aggregate within single database first (1.7M → few rows), then join results. Total time: ~6-8s instead of timeout.

  - title: Text Search in Cross-Database When Specific IRI Available
    problem: "Using bif:contains in cross-database queries without checking co-located database MIE files for structured properties."
    wrong_sparql: |
      # BAD: Text search without checking ChEBI MIE file
      GRAPH <http://rdf.ebi.ac.uk/dataset/chebi> {
        ?chebiId rdfs:label ?label .
        ?label bif:contains "'ciprofloxacin'"
      }
    correct_sparql: |
      # CORRECT: Checked ChEBI MIE file first
      # 1. get_MIE_file("chebi") → found OLS4:searchClasses available
      # 2. OLS4:searchClasses("ciprofloxacin") → found CHEBI:100241
      # 3. Use specific IRI for precise linkage:
      PREFIX obo: <http://purl.obolibrary.org/obo/>
      GRAPH <http://rdf.ebi.ac.uk/dataset/chebi> {
        obo:CHEBI_100241 rdfs:label ?label .
        OPTIONAL { obo:CHEBI_100241 chebi:formula ?formula }
      }
    explanation: |
      For cross-database queries, ALWAYS check MIE files for ALL databases involved. ChEBI has OLS4:searchClasses to find specific IRIs. Using specific IRI ensures fast, accurate, comprehensive results.

  - title: Missing LIMIT or Graph Specification
    problem: "Broad aggregations without LIMIT or FROM clause timeout on large datasets."
    wrong_sparql: |
      # BAD: No LIMIT, no FROM clause
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?ab (COUNT(*) as ?c)
      WHERE { ?s a amr:PhenotypeMeasurement ; amr:antibioticName ?ab }
      GROUP BY ?ab
    correct_sparql: |
      # CORRECT: Use FROM clause and LIMIT
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?ab (COUNT(*) as ?c)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE { ?s a amr:PhenotypeMeasurement ; amr:antibioticName ?ab }
      GROUP BY ?ab
      ORDER BY DESC(?c)
      LIMIT 50
    explanation: |
      Always use FROM clause to specify the graph explicitly. Add LIMIT for broad aggregations. Consider adding geographic or temporal filters for better performance.

common_errors:
  - error: "Query timeout on aggregations"
    causes:
      - "No LIMIT on exploratory queries"
      - "Organism + phenotype filter without additional constraints"
      - "Multiple phenotype-genotype JOINs without pre-filtering"
      - "Cross-GRAPH aggregation instead of two-stage pattern"
    solutions:
      - "Add LIMIT 100 initially for exploration"
      - "Use two-stage aggregation pattern for cross-database queries"
      - "Add single antibiotic filter to reduce result set"
      - "Add geographic/temporal filters for broad queries"
      - "Cross-DB: use reverse join (small→large) strategy"
      - "Use SAMPLE() for representative data instead of full aggregation"
    example_fix: |
      # Timeout: organism + phenotype without constraints
      WHERE { ?s amr:organism ?o ; amr:resistancePhenotype "resistant" }
      
      # Works: add geographic filter and LIMIT
      WHERE {
        ?s amr:organism ?o ;
           amr:geographicalRegion "Asia" ;
           amr:resistancePhenotype "resistant" .
      }
      LIMIT 50

  - error: "Empty results when using ARO IDs"
    causes:
      - "Using wrong ARO IRI format or namespace"
      - "7.3% of phenotypes lack ARO IDs"
      - "Typo in ARO IRI"
    solutions:
      - "Verify ARO IRI format: http://purl.obolibrary.org/obo/ARO_NNNNNNN"
      - "Use OPTIONAL for ARO IDs when coverage is important"
      - "Test with known antibiotics first (ciprofloxacin: ARO_0000036)"
      - "Use antibiotic name as fallback when ARO not available"
    example_fix: |
      # May fail if ARO missing or wrong format
      WHERE { ?s amr:antibioticOntologyId <http://purl.obolibrary.org/obo/ARO_0000036> }
      
      # Better: combine with name for completeness
      WHERE {
        ?s amr:antibioticName "ciprofloxacin" .
        OPTIONAL { ?s amr:antibioticOntologyId ?aro }
      }

  - error: "Incomplete genotype-phenotype linkage"
    causes:
      - "Not all biosamples have both phenotypes and genotypes"
      - "Only 65% of phenotype biosamples have corresponding genotypes"
      - "Only 78.5% of genotypes have antibiotic annotations"
    solutions:
      - "Check coverage statistics before designing complex linkage queries"
      - "Use specific bioSample filters for known linked samples"
      - "Verify linkage with COUNT queries before detailed analysis"
      - "Use LIMIT for initial testing of linkage patterns"
      - "Consider using OPTIONAL for genotype linkage"
    example_fix: |
      # Verify linkage coverage first
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?b (COUNT(?p) as ?phenoCount) (COUNT(?g) as ?genoCount)
      WHERE {
        ?p a amr:PhenotypeMeasurement ; amr:bioSample ?b .
        ?g a amr:GenotypeFeature ; amr:bioSample ?b .
      }
      GROUP BY ?b
      LIMIT 10

schema_info:
  title: AMR Portal RDF Database
  description: |
    The AMR Portal RDF database integrates antimicrobial resistance (AMR) surveillance data from NCBI Pathogen Detection, PATRIC, and CABBAGE. 
    It contains 1.7 million phenotypic antimicrobial susceptibility test results and 1.1 million genotypic AMR features from bacterial isolates worldwide.
    Main entity types: PhenotypeMeasurement (resistance test results with MIC values and disk diffusion), GenotypeFeature (AMR genes, mutations, and resistance elements).
    Key applications: epidemiological resistance pattern analysis, genotype-phenotype correlation studies, geographic surveillance, and temporal trend monitoring across pathogenic bacteria.
    
  endpoint: https://rdfportal.org/ebi/sparql
  base_uri: http://example.org/ebiamr#
  graphs:
    - http://rdfportal.org/dataset/amrportal
  kw_search_tools:
    - sparql
  version:
    mie_version: '1.3'
    mie_created: '2025-01-26'
    data_version: Current as of 2025
    update_frequency: Irregular updates from source databases
  license:
    data_license: Public domain data from NCBI and EBI resources
    license_url: https://www.ebi.ac.uk/about/terms-of-use
  access:
    rate_limiting: Standard SPARQL endpoint rate limits apply
    max_query_timeout: 60 seconds for complex queries
    backend: Virtuoso

shape_expressions: |
  PREFIX rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#>
  PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
  PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>
  PREFIX dct: <http://purl.org/dc/terms/>
  PREFIX amr: <http://example.org/ebiamr#>
  PREFIX obo: <http://purl.obolibrary.org/obo/>
  
  <PhenotypeShape> {
    a [ amr:PhenotypeMeasurement ] ;
    amr:organism xsd:string ;
    amr:species xsd:string ;
    amr:genus xsd:string ;
    amr:antibioticName xsd:string ;
    amr:antibioticOntologyId IRI ? ;
    amr:antibioticOntology IRI ? ;
    amr:resistancePhenotype xsd:string ;
    amr:bioSample IRI ;
    amr:assemblyId IRI ? ;
    amr:sraAccession IRI ? ;
    amr:country xsd:string ? ;
    amr:geographicalRegion xsd:string ? ;
    amr:geographicalSubregion xsd:string ? ;
    amr:isoCountryCode xsd:string ? ;
    amr:collectionYear xsd:integer ? ;
    amr:isolateId xsd:string ? ;
    amr:isolationSource xsd:string ? ;
    amr:isolationCategory xsd:string ? ;
    amr:host xsd:string ? ;
    amr:laboratoryTypingMethod xsd:string ? ;
    amr:astStandard xsd:string ? ;
    amr:measurementValue xsd:string ? ;
    amr:measurementSign xsd:string ? ;
    amr:measurementUnits xsd:string ? ;
    amr:database xsd:string ? ;
    amr:platform xsd:string ? ;
    amr:isolationLatitude xsd:string ? ;
    amr:isolationLongitude xsd:string ? ;
    dct:references IRI *
  }
  
  <GenotypeShape> {
    a [ amr:GenotypeFeature ] ;
    amr:organism xsd:string ;
    amr:species xsd:string ;
    amr:genus xsd:string ;
    amr:amrClass xsd:string ;
    amr:amrSubclass xsd:string ? ;
    amr:amrElementSymbol xsd:string ;
    amr:geneSymbol xsd:string ;
    amr:bioSample IRI ;
    amr:assemblyId IRI ;
    amr:elementType xsd:string ;
    amr:elementSubtype xsd:string ? ;
    amr:featureId xsd:string ;
    amr:region xsd:string ;
    amr:regionStart xsd:integer ;
    amr:regionEnd xsd:integer ;
    amr:strand xsd:string ;
    amr:evidenceType xsd:string ? ;
    amr:evidenceAccession xsd:string ? ;
    amr:evidenceDescription xsd:string ? ;
    amr:evidenceLink IRI ? ;
    amr:bin xsd:string ? ;
    amr:antibioticName xsd:string ? ;
    amr:antibioticOntologyId xsd:string ? ;
    amr:antibioticOntology IRI ? ;
    amr:amrSplitSubclass xsd:string ? ;
    obo:RO_0002162 IRI
  }

sample_rdf_entries:
  - title: Phenotypic AMR Measurement
    description: |
      Antimicrobial susceptibility test result showing trimethoprim-sulfamethoxazole susceptibility in Streptococcus pneumoniae from Thailand.
      
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      @prefix dct: <http://purl.org/dc/terms/> .
      @prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
      
      [] a amr:PhenotypeMeasurement ;
        amr:organism "Streptococcus pneumoniae" ;
        amr:species "Streptococcus pneumoniae" ;
        amr:genus "Streptococcus" ;
        amr:antibioticName "trimethoprim-sulfamethoxazole" ;
        amr:antibioticOntologyId <http://purl.obolibrary.org/obo/ARO_3004024> ;
        amr:antibioticOntology <https://www.ebi.ac.uk/ols4/ontologies/aro/classes/http%3A%2F%2Fpurl.obolibrary.org%2Fobo%2FARO_3004024> ;
        amr:resistancePhenotype "susceptible" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA1028830> ;
        amr:assemblyId <http://identifiers.org/insdc.gca/GCA_001096525.1> ;
        amr:sraAccession <https://identifiers.org/insdc.sra/ERS022205> ;
        amr:country "Thailand" ;
        amr:geographicalRegion "Asia" ;
        amr:geographicalSubregion "South-eastern Asia" ;
        amr:isoCountryCode "THA" ;
        amr:collectionYear 2010 ;
        amr:isolateId "SMRU2695" ;
        amr:isolationSource "nasopharynx" ;
        amr:isolationCategory "respiratory tract" ;
        amr:host "Homo sapiens" ;
        amr:laboratoryTypingMethod "disk diffusion" ;
        amr:astStandard "CLSI" ;
        amr:database "CABBAGE_PubMed_data" ;
        dct:references <http://rdf.ncbi.nlm.nih.gov/pubmed/24509479> .
        
  - title: Genotypic AMR Feature
    description: |
      Efflux pump gene norM detected in Neisseria gonorrhoeae genome with genomic coordinates and evidence.
      
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      @prefix obo: <http://purl.obolibrary.org/obo/> .
      @prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
      
      [] a amr:GenotypeFeature ;
        amr:organism "Neisseria gonorrhoeae" ;
        amr:species "Neisseria gonorrhoeae" ;
        amr:genus "Neisseria" ;
        amr:amrClass "EFFLUX" ;
        amr:amrSubclass "EFFLUX" ;
        amr:amrElementSymbol "norM" ;
        amr:geneSymbol "mdtK" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA104147270> ;
        amr:assemblyId <https://identifiers.org/insdc.sra/ERZ25089697> ;
        amr:elementType "AMR" ;
        amr:elementSubtype "AMR" ;
        amr:featureId "ERZ25089697_00148" ;
        amr:region "ERZ25089697.1" ;
        amr:regionStart 136650 ;
        amr:regionEnd 138029 ;
        amr:strand "-" ;
        amr:evidenceType "HMM" ;
        amr:evidenceAccession "NF000263.1" ;
        amr:evidenceDescription "sodium-coupled multidrug efflux MATE transporter NorM" ;
        amr:evidenceLink <https://www.ncbi.nlm.nih.gov/genome/annotation_prok/evidence/NF000263/> ;
        amr:bin "9363" ;
        obo:RO_0002162 <http://identifiers.org/taxonomy/485> .
        
  - title: Quantitative MIC Measurement
    description: |
      Broth dilution MIC test showing meropenem resistance in Klebsiella pneumoniae with quantitative measurement value and units.
      
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      @prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
      
      [] a amr:PhenotypeMeasurement ;
        amr:organism "Klebsiella pneumoniae" ;
        amr:antibioticName "meropenem" ;
        amr:resistancePhenotype "resistant" ;
        amr:laboratoryTypingMethod "broth dilution" ;
        amr:astStandard "CLSI" ;
        amr:measurementValue "16" ;
        amr:measurementSign ">=" ;
        amr:measurementUnits "mg/L" ;
        amr:platform "BD Phoenix" .
        
  - title: Geographic Metadata Example
    description: |
      Resistance measurement with complete geographic hierarchy including region, subregion, country and ISO code.
      
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      @prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
      
      [] a amr:PhenotypeMeasurement ;
        amr:organism "Escherichia coli" ;
        amr:antibioticName "ciprofloxacin" ;
        amr:resistancePhenotype "resistant" ;
        amr:country "United States of America" ;
        amr:geographicalRegion "Americas" ;
        amr:geographicalSubregion "Northern America" ;
        amr:isoCountryCode "USA" ;
        amr:collectionYear 2020 ;
        amr:isolationSource "urine" ;
        amr:isolationCategory "urinary tract" ;
        amr:host "Homo sapiens" .
        
  - title: Linked Phenotype-Genotype Data
    description: |
      Acinetobacter baumannii isolate with both amikacin resistance phenotype and macrolide resistance gene msr(E) linked via bioSample.
      
    rdf: |
      @prefix amr: <http://example.org/ebiamr#> .
      @prefix dct: <http://purl.org/dc/terms/> .
      @prefix obo: <http://purl.obolibrary.org/obo/> .
      @prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
      
      [] a amr:PhenotypeMeasurement ;
        amr:organism "Acinetobacter baumannii" ;
        amr:antibioticName "amikacin" ;
        amr:resistancePhenotype "resistant" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA1569508> ;
        amr:collectionYear 2010 ;
        amr:country "Viet Nam" ;
        amr:isolateId "BAL_190" ;
        amr:laboratoryTypingMethod "disk diffusion" ;
        dct:references <http://rdf.ncbi.nlm.nih.gov/pubmed/28348846> .
      
      [] a amr:GenotypeFeature ;
        amr:organism "Acinetobacter baumannii" ;
        amr:amrClass "MACROLIDE/STREPTOGRAMIN" ;
        amr:amrElementSymbol "msr(E)" ;
        amr:geneSymbol "msr(E)" ;
        amr:bioSample <https://identifiers.org/biosample/SAMEA1569508> ;
        amr:region "ERZ3116948.45" ;
        amr:regionStart 5159 ;
        amr:regionEnd 6634 ;
        amr:antibioticName "erythromycin" ;
        obo:RO_0002162 <http://identifiers.org/taxonomy/470> .

sparql_query_examples:
  - title: Keyword search for organism using bif:contains
    description: |
      Find resistance measurements for Escherichia coli using Virtuoso's bif:contains for efficient keyword matching.
      
    question: What resistance data is available for Escherichia coli?
    complexity: basic
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT ?s ?organism ?antibiotic ?phenotype
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:organism ?organism .
        ?s amr:antibioticName ?antibiotic .
        ?s amr:resistancePhenotype ?phenotype .
        ?organism bif:contains "'Escherichia'" option (score ?sc) .
      }
      ORDER BY DESC(?sc)
      LIMIT 10
      
  - title: Filter by resistance phenotype
    description: |
      Retrieve resistant isolates for a specific organism without expensive organism filtering.
      
    question: What antibiotics show resistance in Salmonella enterica?
    complexity: basic
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT DISTINCT ?antibiotic (COUNT(*) as ?count)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:organism "Salmonella enterica" .
        ?s amr:antibioticName ?antibiotic .
        ?s amr:resistancePhenotype "resistant" .
      }
      GROUP BY ?antibiotic
      ORDER BY DESC(?count)
      LIMIT 20
      
  - title: Geographic distribution using SAMPLE for efficiency
    description: |
      Analyze resistance patterns by geographic region using SAMPLE aggregate to avoid expensive full data collection.
      
    question: Which countries have ciprofloxacin resistance data?
    complexity: intermediate
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT ?country ?region 
             (COUNT(*) as ?totalTests)
             (SUM(IF(?phenotype = "resistant", 1, 0)) as ?resistantCount)
             (SAMPLE(?year) as ?sampleYear)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:antibioticName "ciprofloxacin" .
        ?s amr:resistancePhenotype ?phenotype .
        ?s amr:country ?country .
        ?s amr:geographicalRegion ?region .
        OPTIONAL { ?s amr:collectionYear ?year . }
      }
      GROUP BY ?country ?region
      HAVING (?totalTests > 10)
      ORDER BY DESC(?resistantCount)
      LIMIT 20
      
  - title: AMR gene class distribution with biological context
    description: |
      Identify prevalence of AMR gene classes across bacterial species using taxonomy annotations.
      
    question: What are the most common AMR gene classes in different bacterial species?
    complexity: intermediate
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX obo: <http://purl.obolibrary.org/obo/>
      
      SELECT ?amrClass ?species (COUNT(*) as ?geneCount)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:GenotypeFeature .
        ?s amr:amrClass ?amrClass .
        ?s amr:species ?species .
        ?s obo:RO_0002162 ?taxonId .
      }
      GROUP BY ?amrClass ?species
      ORDER BY DESC(?geneCount)
      LIMIT 20
      
  - title: Temporal trend analysis (single antibiotic)
    description: |
      Track resistance trends over time for specific antibiotic. Use single antibiotic to avoid timeout.
      
    question: How has ciprofloxacin resistance changed over the years?
    complexity: intermediate
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT ?year (COUNT(*) as ?total) (SUM(?isResistant) as ?resistant)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:antibioticName "ciprofloxacin" .
        ?s amr:collectionYear ?year .
        ?s amr:resistancePhenotype ?phenotype .
        BIND(IF(?phenotype = "resistant", 1, 0) as ?isResistant)
        FILTER(?year >= 2010 && ?year <= 2023)
      }
      GROUP BY ?year
      ORDER BY ?year
      
  - title: Genotype-phenotype correlation (two-stage pattern)
    description: |
      Link AMR genes with resistance phenotypes in same isolates. This example shows linking pattern; for production use two-stage approach.
      
    question: Which beta-lactam resistance genes are found with carbapenem resistance?
    complexity: advanced
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT DISTINCT ?geneSymbol ?amrClass ?bioSample
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?pheno a amr:PhenotypeMeasurement .
        ?pheno amr:bioSample ?bioSample .
        ?pheno amr:antibioticName "meropenem" .
        ?pheno amr:resistancePhenotype "resistant" .
        
        ?geno a amr:GenotypeFeature .
        ?geno amr:bioSample ?bioSample .
        ?geno amr:geneSymbol ?geneSymbol .
        ?geno amr:amrClass ?amrClass .
        FILTER(CONTAINS(?amrClass, "BETA-LACTAM"))
      }
      LIMIT 50
      
  - title: Multi-drug resistance profiling with SAMPLE
    description: |
      Identify isolates with resistance to multiple antibiotics using efficient aggregation patterns.
      
    question: Find isolates resistant to at least 3 different antibiotics
    complexity: advanced
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT ?bioSample ?organism 
             (COUNT(DISTINCT ?antibiotic) as ?resistantDrugCount)
             (SAMPLE(?country) as ?sampleCountry)
             (SAMPLE(?year) as ?sampleYear)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:bioSample ?bioSample .
        ?s amr:organism ?organism .
        ?s amr:antibioticName ?antibiotic .
        ?s amr:resistancePhenotype "resistant" .
        OPTIONAL { ?s amr:country ?country . }
        OPTIONAL { ?s amr:collectionYear ?year . }
      }
      GROUP BY ?bioSample ?organism
      HAVING (COUNT(DISTINCT ?antibiotic) >= 3)
      ORDER BY DESC(?resistantDrugCount)
      LIMIT 20

cross_database_queries:
  shared_endpoint: ebi
  co_located_databases:
    - chembl
    - chebi
    - reactome
    - ensembl
  examples:
    - title: Link AMR surveillance to ChEMBL compound properties (optimized)
      description: |
        Integrate AMR Portal resistance data with ChEMBL compound information using reverse join order optimization.
        Start with small ChEMBL dataset (specific molecules) then join to larger AMR Portal dataset for best performance.
        This pattern enables enriching resistance surveillance with chemical properties and development status.
        
      databases_used:
        - amrportal
        - chembl
      complexity: intermediate
      sparql: |
        PREFIX amr: <http://example.org/ebiamr#>
        PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        
        SELECT ?chemblLabel ?chemblMolecule ?antibioticName
        WHERE {
          GRAPH <http://rdf.ebi.ac.uk/dataset/chembl> {
            VALUES ?chemblLabel { "CIPROFLOXACIN" "AMPICILLIN" "GENTAMICIN" }
            ?chemblMolecule a cco:SmallMolecule ;
                            rdfs:label ?chemblLabel .
          }
          
          BIND(LCASE(?chemblLabel) AS ?antibioticName)
          
          GRAPH <http://rdfportal.org/dataset/amrportal> {
            ?measurement a amr:PhenotypeMeasurement ;
                         amr:antibioticName ?antibioticName .
          }
        }
        LIMIT 10
        
      notes: |
        - OPTIMIZATION: Reverse join order - start with ChEMBL (3 molecules) then join to AMR Portal
        - Graph URIs from chembl and amrportal MIE files
        - Performance: ~1-2 seconds (vs timeout with traditional join order)
        - Use BIND(LCASE()) to match ChEMBL uppercase labels to AMR Portal lowercase names
        - For statistics, use two-stage approach: aggregate in AMR Portal first, then join results
        - Entity types verified against chembl MIE shape expressions (cco:SmallMolecule)
        
    - title: Two-stage aggregation for resistance statistics with ChEMBL enrichment
      description: |
        Demonstrates optimal pattern for analytical queries: aggregate within AMR Portal first, then join pre-computed results to ChEMBL.
        This avoids cross-database aggregation bottleneck and completes in ~6 seconds total.
        Stage 1 processes 1.7M records down to a few rows; Stage 2 joins these to ChEMBL trivially.
        
      databases_used:
        - amrportal
        - chembl
      complexity: advanced
      sparql: |
        # STAGE 1: Run this query first (5 seconds) - AMR Portal only
        PREFIX amr: <http://example.org/ebiamr#>
        
        SELECT ?antibioticName 
               (COUNT(*) as ?totalMeasurements)
               (SUM(IF(?phenotype = "resistant", 1, 0)) as ?resistantCount)
        FROM <http://rdfportal.org/dataset/amrportal>
        WHERE {
          ?measurement a amr:PhenotypeMeasurement ;
                       amr:antibioticName ?antibioticName ;
                       amr:resistancePhenotype ?phenotype .
          FILTER(?antibioticName IN ("ciprofloxacin", "ampicillin", "gentamicin"))
        }
        GROUP BY ?antibioticName
        ORDER BY DESC(?resistantCount)
        
        # STAGE 2: Use results from Stage 1 in VALUES clause (1 second)
        PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        
        SELECT ?antibioticName ?resistantCount ?chemblMolecule ?chemblLabel
        WHERE {
          VALUES (?antibioticName ?resistantCount) {
            ("ampicillin" 21660)        # Results from Stage 1
            ("ciprofloxacin" 21368)
            ("gentamicin" 15234)
          }
          
          ?chemblMolecule a cco:SmallMolecule ;
                          rdfs:label ?chemblLabel .
          FILTER(LCASE(?chemblLabel) = ?antibioticName)
        }
        ORDER BY DESC(?resistantCount)
        
      notes: |
        - CRITICAL: Never aggregate across GRAPH boundaries - always use two-stage pattern
        - Stage 1 reduces 1.7M records to 3 aggregated rows (massive reduction)
        - Stage 2 joins 3 rows to ChEMBL (trivial operation)
        - Total time: ~6 seconds (5s + 1s) vs timeout with single-stage cross-database aggregation
        - Pattern works for any aggregation: COUNT, SUM, AVG, MIN, MAX
        - Can add organism/phenotype filters in Stage 1 without timeout
        - Graph URIs and prefixes from amrportal and chembl MIE files
        
    - title: Geographic resistance patterns with SAMPLE for representative data
      description: |
        Analyze resistance distribution by region using SAMPLE aggregate to get representative examples without expensive full data collection.
        Demonstrates efficient cross-database pattern for exploratory analysis.
        
      databases_used:
        - amrportal
        - chembl
      complexity: intermediate
      sparql: |
        PREFIX amr: <http://example.org/ebiamr#>
        PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
        PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
        
        SELECT ?region ?antibioticName ?chemblLabel
               (COUNT(*) as ?totalTests)
               (SUM(IF(?phenotype = "resistant", 1, 0)) as ?resistantCount)
               (SAMPLE(?country) as ?exampleCountry)
        WHERE {
          GRAPH <http://rdfportal.org/dataset/amrportal> {
            ?measurement a amr:PhenotypeMeasurement ;
                         amr:antibioticName ?antibioticName ;
                         amr:geographicalRegion ?region ;
                         amr:resistancePhenotype ?phenotype .
            OPTIONAL { ?measurement amr:country ?country . }
            FILTER(?region = "Americas" && ?antibioticName = "ciprofloxacin")
          }
          
          GRAPH <http://rdf.ebi.ac.uk/dataset/chembl> {
            ?chemblMolecule a cco:SmallMolecule ;
                            rdfs:label ?chemblLabel .
            FILTER(LCASE(?chemblLabel) = ?antibioticName)
          }
        }
        GROUP BY ?region ?antibioticName ?chemblLabel
        LIMIT 20
        
      notes: |
        - OPTIMIZATION: Geographic filter applied BEFORE cross-database join
        - SAMPLE() aggregate gets representative examples efficiently
        - Performance: ~3-5 seconds (geographic filtering reduces dataset)
        - Filter to single region and antibiotic to avoid timeout
        - For multiple antibiotics, use two-stage pattern or iterate
        - Graph URIs from chembl and amrportal MIE files

cross_references:
  - pattern: amr:bioSample
    description: |
      Links to NCBI BioSample database providing sample metadata including collection details, host information, and isolation source.
      Primary key for linking phenotype and genotype data from the same bacterial isolate.
      
    databases:
      sequence_archives:
        - 'BioSample: ~1.4M unique samples linked from phenotype and genotype data'
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT DISTINCT ?bioSample
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s amr:bioSample ?bioSample .
      }
      LIMIT 100
      
  - pattern: amr:sraAccession
    description: |
      Links to NCBI Sequence Read Archive (SRA) for raw sequencing data associated with isolates.
      
    databases:
      sequence_archives:
        - 'SRA: ~870K SRA accessions linked from phenotype data'
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT DISTINCT ?sraAccession
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:sraAccession ?sraAccession .
      }
      LIMIT 100
      
  - pattern: amr:assemblyId
    description: |
      Links to INSDC genome assemblies (GenBank GCA or SRA ERZ accessions) containing assembled genome sequences.
      
    databases:
      sequence_archives:
        - 'INSDC/GenBank: ~890K assembly identifiers'
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT DISTINCT ?assemblyId
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s amr:assemblyId ?assemblyId .
      }
      LIMIT 100
      
  - pattern: dct:references
    description: |
      Citations to PubMed literature from which resistance data was extracted or published.
      
    databases:
      literature:
        - 'PubMed: Multiple publications referenced per study'
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX dct: <http://purl.org/dc/terms/>
      
      SELECT DISTINCT ?pubmed
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s dct:references ?pubmed .
      }
      LIMIT 100
      
  - pattern: amr:antibioticOntologyId
    description: |
      Links to Antibiotic Resistance Ontology (ARO) terms for standardized antibiotic classification.
      
    databases:
      ontologies:
        - 'ARO: Standardized antibiotic terms from CARD database'
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT DISTINCT ?aroTerm ?antibiotic
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:antibioticName ?antibiotic .
        ?s amr:antibioticOntologyId ?aroTerm .
      }
      LIMIT 100
      
  - pattern: obo:RO_0002162 (in taxon)
    description: |
      Links genotype features to NCBI Taxonomy identifiers for organism classification using standard RO relation.
      
    databases:
      taxonomy:
        - 'NCBI Taxonomy: Organism identifiers for all genotype features'
    sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX obo: <http://purl.obolibrary.org/obo/>
      
      SELECT DISTINCT ?taxonId ?organism
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:GenotypeFeature .
        ?s amr:organism ?organism .
        ?s obo:RO_0002162 ?taxonId .
      }
      LIMIT 100

architectural_notes:
  schema_design:
    - Two main entity types (PhenotypeMeasurement and GenotypeFeature) representing phenotypic and genotypic AMR data
    - Blank nodes used for all measurements (no direct URIs for individual records)
    - BioSample IRI serves as primary linkage between phenotype and genotype data from same isolate
    - Geographic hierarchy (region → subregion → country → ISO code) enables multi-level spatial analysis
    - Temporal coverage spans 1911-2025 with 92 distinct collection years
    - Antibiotic names use free text with optional links to ARO ontology for standardization
  performance:
    - Large dataset (1.7M phenotype + 1.1M genotype records) requires careful query design
    - CRITICAL - Organism + phenotype combined filtering causes timeout - use two-stage approach
    - Use LIMIT clauses for exploratory queries to avoid timeouts
    - Filter by single antibiotic before aggregations or use two-stage pattern
    - Geographic and temporal filters help when applied BEFORE cross-database joins
    - bif:contains enables efficient keyword search on organism names and text fields
    - SAMPLE() aggregate much faster than collecting all values for representative data
    - Cross-database queries - use reverse join order (ChEMBL → AMR) or two-stage aggregation
    - NEVER aggregate across GRAPH boundaries - always aggregate within single database first
  data_integration:
    - Links to BioSample (NCBI), SRA (sequence data), INSDC assemblies, PubMed literature, ARO ontology
    - Phenotype-genotype linkage via shared bioSample IRIs enables correlation studies
    - Evidence links point to NCBI Pathogen Detection annotation for gene predictions
    - Database field tracks data source (PATRIC, CABBAGE_PubMed_data, NCBI)
    - Co-located with chembl, chebi, reactome, ensembl on EBI endpoint for cross-database queries
    - ChEMBL integration enables compound property enrichment via antibiotic name matching
    - ChEBI provides chemical ontology classifications for antibiotics
    - Use two-stage aggregation pattern for cross-database analytics (aggregate first, then join)
  data_quality:
    - Resistance phenotype values use controlled vocabulary (resistant, susceptible, intermediate, non-susceptible, susceptible-dose dependent)
    - Laboratory typing methods include broth dilution (56%), agar dilution (8%), disk diffusion (7%), E-test (2%)
    - Geographic data completeness varies - not all records have full geographic hierarchy
    - Isolation sources have inconsistent capitalization (Stool/stool, Urine/urine, Blood/blood)
    - Evidence type in genotype data predominantly HMM (65% of features with evidence type specified)
    - Quantitative MIC measurements available for subset of phenotype records via measurementValue/Sign/Units

data_statistics:
  total_phenotype_measurements: 1714486
  total_genotype_features: 1164007
  total_unique_biosamples: approximately 1.4 million
  total_organisms: 20+ bacterial species with major representation
  coverage:
    phenotype_with_geographic_data: approximately 80%
    phenotype_with_temporal_data: approximately 85%
    phenotype_with_quantitative_mic: approximately 30%
    genotype_with_evidence: approximately 65%
    genotype_with_antibiotic_name: approximately 35%
  cardinality:
    avg_phenotypes_per_biosample: approximately 1.2
    avg_genotypes_per_biosample: approximately 0.8
    resistance_distribution: 18% resistant, 61% susceptible, 2% intermediate
    geographic_coverage: 150+ countries across all continents
  performance_characteristics:
    - Queries filtering on single antibiotic return results in less than 5 seconds
    - Aggregations without organism/phenotype filters complete in 5-10 seconds
    - Organism + phenotype combined filtering causes timeout - use two-stage approach
    - bif:contains keyword search performs well with score-based ranking
    - JOIN operations between phenotype and genotype by bioSample work for targeted queries
    - Cross-database queries using reverse join order (ChEMBL → AMR) complete in 1-2 seconds
    - Cross-database aggregation using two-stage pattern completes in approximately 6 seconds total
    - Geographic filtering reduces dataset effectively for regional analyses
    - SAMPLE() aggregate provides representative data in 2-3 seconds
  data_quality_notes:
    - Inconsistent text capitalization in isolation sources and some fields
    - Geographic hierarchy incomplete for some records
    - Temporal range very broad (1911-2025) but concentrated in recent decades
    - AMR class names use abbreviated forms (e.g., BETA-LACTAM, MACROLIDE)

anti_patterns:
  - title: Cross-database aggregation (causes timeout)
    problem: |
      Attempting to aggregate across GRAPH boundaries with organism and phenotype filters creates massive intermediate result sets that timeout.
      
    wrong_sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
      PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
      
      SELECT ?antibioticName (COUNT(DISTINCT ?measurement) as ?resistanceCount)
      WHERE {
        GRAPH <http://rdfportal.org/dataset/amrportal> {
          ?measurement a amr:PhenotypeMeasurement ;
                       amr:antibioticName ?antibioticName ;
                       amr:organism "Escherichia coli" ;
                       amr:resistancePhenotype "resistant" .
        }
        GRAPH <http://rdf.ebi.ac.uk/dataset/chembl> {
          ?chemblMolecule a cco:SmallMolecule ;
                          rdfs:label ?chemblLabel .
          FILTER(LCASE(?chemblLabel) = LCASE(?antibioticName))
        }
      }
      GROUP BY ?antibioticName
      
    correct_sparql: |
      # STAGE 1: Aggregate within AMR Portal (5 seconds)
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT ?antibioticName (COUNT(*) as ?resistanceCount)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?measurement a amr:PhenotypeMeasurement ;
                     amr:antibioticName ?antibioticName ;
                     amr:organism "Escherichia coli" ;
                     amr:resistancePhenotype "resistant" .
      }
      GROUP BY ?antibioticName
      ORDER BY DESC(?resistanceCount)
      LIMIT 10
      
      # STAGE 2: Join aggregated results to ChEMBL (1 second)
      PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
      PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
      
      SELECT ?antibioticName ?resistanceCount ?chemblMolecule ?chemblLabel
      WHERE {
        VALUES (?antibioticName ?resistanceCount) {
          ("ciprofloxacin" 15234)  # From Stage 1 results
          ("ampicillin" 12456)
        }
        ?chemblMolecule a cco:SmallMolecule ;
                        rdfs:label ?chemblLabel .
        FILTER(LCASE(?chemblLabel) = ?antibioticName)
      }
      ORDER BY DESC(?resistanceCount)
      
    explanation: |
      Use two-stage pattern: aggregate within single database first, then join pre-computed results.
      Stage 1 processes 1.7M records down to a few rows. Stage 2 trivially joins these to ChEMBL.
      Never aggregate across GRAPH boundaries directly.
      
  - title: Large to small join order (inefficient)
    problem: |
      Starting with large AMR Portal dataset filtered by organism creates 100K+ intermediate results before joining to ChEMBL.
      
    wrong_sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
      PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
      
      SELECT ?antibioticName ?chemblLabel
      WHERE {
        GRAPH <http://rdfportal.org/dataset/amrportal> {
          ?measurement a amr:PhenotypeMeasurement ;
                       amr:antibioticName ?antibioticName ;
                       amr:organism "Escherichia coli" .
        }
        GRAPH <http://rdf.ebi.ac.uk/dataset/chembl> {
          ?chemblMolecule a cco:SmallMolecule ;
                          rdfs:label ?chemblLabel .
          FILTER(LCASE(?chemblLabel) = LCASE(?antibioticName))
        }
      }
      LIMIT 10
      
    correct_sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      PREFIX cco: <http://rdf.ebi.ac.uk/terms/chembl#>
      PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>
      
      SELECT ?chemblLabel ?antibioticName
      WHERE {
        GRAPH <http://rdf.ebi.ac.uk/dataset/chembl> {
          VALUES ?chemblLabel { "CIPROFLOXACIN" "AMPICILLIN" }
          ?chemblMolecule a cco:SmallMolecule ;
                          rdfs:label ?chemblLabel .
        }
        
        BIND(LCASE(?chemblLabel) AS ?antibioticName)
        
        GRAPH <http://rdfportal.org/dataset/amrportal> {
          ?measurement a amr:PhenotypeMeasurement ;
                       amr:antibioticName ?antibioticName .
        }
      }
      LIMIT 10
      
    explanation: |
      Use reverse join order: start with small ChEMBL dataset (2 molecules) then join to large AMR Portal.
      ChEMBL filtered to specific drugs gives 1-5 results. AMR Portal has 1.7M measurements.
      Starting with 2 molecules then filtering AMR is much faster than filtering 100K+ AMR records then matching to ChEMBL.
      
  - title: Querying without organism filter or LIMIT
    problem: |
      Attempting broad aggregations without selective filters or limits leads to timeouts on large dataset.
      
    wrong_sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT ?antibiotic (COUNT(*) as ?count)
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:antibioticName ?antibiotic .
      }
      GROUP BY ?antibiotic
      
    correct_sparql: |
      PREFIX amr: <http://example.org/ebiamr#>
      
      SELECT ?antibiotic (COUNT(*) as ?count)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:antibioticName ?antibiotic .
      }
      GROUP BY ?antibiotic
      ORDER BY DESC(?count)
      LIMIT 50
      
    explanation: |
      Always specify FROM clause for graph context and use LIMIT to prevent timeouts.
      For broad queries, filter by antibiotic or geographic region before aggregating.

common_errors:
  - error: Query timeout on complex aggregations
    causes:
      - Attempting to aggregate over full 1.7M phenotype dataset without filters
      - Combining organism and phenotype filtering (creates large intermediate sets)
      - Multiple JOINs between phenotype and genotype without selective criteria
      - Missing LIMIT clause on exploratory queries
      - Cross-database aggregation (aggregating across GRAPH boundaries)
    solutions:
      - Use two-stage aggregation pattern (aggregate first, then join)
      - Add single antibiotic filter to reduce result set
      - Use LIMIT 100 or similar for initial data exploration
      - Apply geographic or temporal filters to narrow scope
      - For cross-database queries, use reverse join order (small → large)
      - Use SAMPLE() aggregate for representative data instead of collecting all values
    example_fix: |
      # Instead of combining organism + phenotype (timeout):
      SELECT ?organism (COUNT(*) as ?count) 
      WHERE { 
        ?s a amr:PhenotypeMeasurement ; 
           amr:organism ?organism ; 
           amr:resistancePhenotype "resistant" . 
      } 
      GROUP BY ?organism
      
      # Use geographic filter first (works):
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?organism (COUNT(*) as ?count)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?s a amr:PhenotypeMeasurement .
        ?s amr:organism ?organism .
        ?s amr:geographicalRegion "Asia" .
        ?s amr:resistancePhenotype "resistant" .
      }
      GROUP BY ?organism
      LIMIT 50
      
  - error: Empty results when matching text values
    causes:
      - Case sensitivity in organism or isolation source values
      - Spelling variations (e.g., "Stool" vs "stool")
      - Using abbreviated organism names not in database
      - Antibiotic name mismatch between AMR Portal (lowercase) and ChEMBL (uppercase)
    solutions:
      - Use bif:contains for flexible text matching with Virtuoso backend
      - Check actual values with DISTINCT queries first
      - Apply FILTER with CONTAINS or regex for partial matching
      - Use LCASE() for case-insensitive cross-database matching
      - For cross-database queries, use BIND(LCASE()) to normalize values
    example_fix: |
      # Instead of exact match that might fail:
      FILTER(?source = "stool")
      
      # Use keyword search:
      ?source bif:contains "'stool'" option (score ?sc)
      
      # Or case-insensitive filter:
      FILTER(CONTAINS(LCASE(?source), "stool"))
      
      # For cross-database ChEMBL matching:
      FILTER(LCASE(?chemblLabel) = LCASE(?antibioticName))
      
      # Or use BIND for efficiency:
      BIND(LCASE(?chemblLabel) AS ?normalizedName)
      FILTER(?antibioticName = ?normalizedName)
      
  - error: Incomplete genotype-phenotype linkage
    causes:
      - Not all bioSamples have both phenotype and genotype data
      - Using OPTIONAL incorrectly causing Cartesian products
      - Expecting genotype features for all organisms (only ~65% of phenotype samples have genotype)
      - Assuming all genotype features have antibiotic names (only ~35% do)
    solutions:
      - Check data coverage before assuming complete linkage
      - Use specific bioSample filters for known linked samples
      - Verify existence with COUNT queries before complex joins
      - Use LIMIT to test linkage patterns before full queries
      - For cross-database queries, verify linking properties exist
    example_fix: |
      # Verify linkage exists first:
      PREFIX amr: <http://example.org/ebiamr#>
      SELECT ?bioSample (COUNT(DISTINCT ?p) as ?phenoCount) (COUNT(DISTINCT ?g) as ?genoCount)
      FROM <http://rdfportal.org/dataset/amrportal>
      WHERE {
        ?p a amr:PhenotypeMeasurement ; amr:bioSample ?bioSample .
        ?g a amr:GenotypeFeature ; amr:bioSample ?bioSample .
      }
      GROUP BY ?bioSample
      LIMIT 10
      
      # Then use verified bioSamples for analysis
